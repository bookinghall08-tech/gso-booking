<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Appointment</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }

    body {
      height: 100vh;
      background: linear-gradient(135deg, #C3B091, #F0E68C, #BDB76B);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
    }

    .container {
      background: rgba(240, 230, 140, 0.25);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 40px 50px;
      width: 100%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .container:hover { transform: translateY(-6px); }

    h2 { color: #4B3E1E; font-size: 2em; margin-bottom: 10px; }

    #selectedDate {
      font-weight: 600;
      color: #3B2F0B;
      margin-bottom: 15px;
      font-size: 1.05em;
    }

    p { color: #5B4C22; margin-bottom: 20px; font-size: 1.05em; }

    form { display: flex; flex-direction: column; align-items: center; gap: 10px; }

    input, select, textarea {
      width: 90%; max-width: 360px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.25);
      color: #3B2F0B;
      font-size: 0.95em;
      outline: none;
      transition: all 0.3s ease;
    }

    input::placeholder, textarea::placeholder { color: rgba(75, 62, 30, 0.7); }

    input:focus, select:focus, textarea:focus {
      border-color: #BDB76B;
      background: rgba(255, 255, 255, 0.35);
    }

    textarea { resize: none; height: 70px; }

    label {
      width: 90%; max-width: 360px;
      text-align: left;
      color: #4B3E1E;
      font-weight: 600;
      margin-top: 12px;
      font-size: 0.95em;
    }

    .equipment-container {
      display: flex; flex-wrap: wrap; justify-content: center;
      gap: 8px; width: 90%; max-width: 360px; margin-bottom: 8px;
    }

    .equipment-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.4);
      color: #4B3E1E;
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      transition: 0.3s ease;
    }

    .equipment-btn.selected {
      background: linear-gradient(135deg, #C3B091, #BDB76B);
      color: #fff;
      transform: scale(1.05);
      border-color: #F0E68C;
    }

    .time-section {
      display: flex; justify-content: center; gap: 8px;
      width: 90%; max-width: 360px;
    }

    button {
      width: 90%; max-width: 360px;
      padding: 14px;
      border: none;
      border-radius: 30px;
      background: linear-gradient(135deg, #BDB76B, #C3B091);
      color: #3B2F0B;
      font-size: 1em; font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 8px;
    }

    button:hover {
      background: linear-gradient(135deg, #C3B091, #BDB76B);
      transform: scale(1.05);
    }

    #successMsg { color: #2E8B57; display: none; margin-top: 8px; font-weight: 600; }

    .back-btn {
      background: transparent; border: 2px solid #4B3E1E;
      color: #4B3E1E; margin-top: 15px; font-size: 0.95em;
    }

    .back-btn:hover { background: #4B3E1E; color: #fff8dc; transform: scale(1.05); }

    #otherActivity, #tablesQty, #chairsQty, #otherEquipment {
      display: none; animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    .container::-webkit-scrollbar { width: 6px; }
    .container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.4); border-radius: 10px; }

    @media (max-width: 480px) {
      .container { padding: 30px 25px; }
      h2 { font-size: 1.7em; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Book Appointment</h2>
    <p id="selectedDate"></p>

    <form id="appointmentForm">
      <input type="email" id="contactPersonEmail" placeholder="Email Address" required />
      <input type="text" id="dateRequest" placeholder="Date of Request" readonly />
      <input type="text" id="requestingOffice" placeholder="Requesting Office" required />
      <input type="text" id="contactPerson" placeholder="Contact Person" required />
      <input type="tel" id="mobileNumber" placeholder="Mobile Number" pattern="[0-9]{11}" maxlength="11" required />
      <input type="text" id="eventTitle" placeholder="Event Title" required />

      <select id="activityType" required>
        <option value="">Type of Activity</option>
        <option value="Training">Training</option>
        <option value="Seminar">Seminar</option>
        <option value="Workshop">Workshop</option>
        <option value="Meeting">Meeting</option>
        <option value="Others">Others</option>
      </select>

      <input type="text" id="otherActivity" placeholder="Please specify activity" />
      <input type="number" id="participants" placeholder="Number of Participants" min="1" required />

      <select id="roomLayout" required>
        <option value="">Room Layout</option>
        <option value="Classroom">Classroom</option>
        <option value="Theater">Theater</option>
        <option value="Board Room">Board Room</option>
      </select>

      <label>Equipment & Services Needed:</label>
      <div class="equipment-container" id="equipmentContainer">
        <div class="equipment-btn" data-value="Projector and Screen">Projector & Screen</div>
        <div class="equipment-btn" data-value="Lectern">Lectern</div>
        <div class="equipment-btn" data-value="Tables">Tables</div>
        <div class="equipment-btn" data-value="Whiteboard">Whiteboard</div>
        <div class="equipment-btn" data-value="Sound System">Sound System</div>
        <div class="equipment-btn" data-value="Flag Stand">Flag Stand</div>
        <div class="equipment-btn" data-value="Chairs">Chairs</div>
        <div class="equipment-btn" data-value="Others">Others</div>
      </div>

      <input type="number" id="tablesQty" placeholder="Enter number of tables" min="1" />
      <input type="number" id="chairsQty" placeholder="Enter number of chairs" min="1" />
      <input type="text" id="otherEquipment" placeholder="Please specify equipment/service" />

      <div class="time-section">
        <select id="startTime" required>
          <option value="">Start Time</option>
          <option>09:00 AM</option><option>10:00 AM</option>
          <option>11:00 AM</option><option>12:00 PM</option>
          <option>01:00 PM</option><option>02:00 PM</option>
          <option>03:00 PM</option><option>04:00 PM</option>
        </select>

        <select id="endTime" required>
          <option value="">End Time</option>
          <option>09:30 AM</option><option>10:30 AM</option>
          <option>11:30 AM</option><option>12:30 PM</option>
          <option>01:30 PM</option><option>02:30 PM</option>
          <option>03:30 PM</option><option>04:30 PM</option><option>05:00 PM</option>
        </select>
      </div>

      <textarea id="notes" placeholder="Additional notes or special requests"></textarea>
      <button type="submit">Submit Appointment</button>
    </form>

    <p id="successMsg">‚úÖ Appointment booked successfully!</p>
    <button class="back-btn" onclick="window.location.href='calendar.html'">‚Üê Back to Calendar</button>
  </div>

<script>
  // ‚úÖ 1Ô∏è‚É£ Always set today's date as the "Date of Request"
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("dateRequest").value = today;

  // ‚úÖ 2Ô∏è‚É£ Get selected date(s) from URL or localStorage
  const urlParams = new URLSearchParams(window.location.search);
  let selectedDates = urlParams.get("dates") || localStorage.getItem("selectedDates");
  let selectedDateArray = selectedDates ? selectedDates.split(",") : [];

  // ‚úÖ 3Ô∏è‚É£ Format selected date(s) for display under the heading
  const formattedList = selectedDateArray.map(d =>
    new Date(d).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric"
    })
  ).join(", ");

  // ‚úÖ 4Ô∏è‚É£ Display under <h2>Book Appointment</h2>
  document.getElementById("selectedDate").textContent =
    formattedList
      ? `üìÖ Selected Date${selectedDateArray.length > 1 ? "s" : ""} to Reserve: ${formattedList}`
      : "üìÖ No date selected. Please go back to choose a date.";

  // === Handle "Others" in Activity type ===
  const activityType = document.getElementById("activityType");
  const otherActivity = document.getElementById("otherActivity");
  activityType.addEventListener("change", () => {
    otherActivity.style.display = (activityType.value === "Others") ? "block" : "none";
  });

  // === Equipment buttons ===
  const equipmentButtons = document.querySelectorAll(".equipment-btn");
  const tablesQty = document.getElementById("tablesQty");
  const chairsQty = document.getElementById("chairsQty");
  const otherEquipment = document.getElementById("otherEquipment");

  equipmentButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      btn.classList.toggle("selected");
      handleExtraInputs();
    });
  });

  function handleExtraInputs() {
    const selected = Array.from(document.querySelectorAll(".equipment-btn.selected")).map(b => b.dataset.value);
    [tablesQty, chairsQty, otherEquipment].forEach(el => el.style.display = "none");
    if (selected.includes("Tables")) tablesQty.style.display = "block";
    if (selected.includes("Chairs")) chairsQty.style.display = "block";
    if (selected.includes("Others")) otherEquipment.style.display = "block";
  }

  function showToast(message, success = true) {
    let toast = document.createElement("div");
    toast.textContent = message;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.padding = "15px 25px";
    toast.style.backgroundColor = success ? "#4CAF50" : "#f44336";
    toast.style.color = "#fff";
    toast.style.borderRadius = "8px";
    toast.style.boxShadow = "0 4px 12px rgba(0,0,0,0.2)";
    toast.style.zIndex = 9999;
    toast.style.fontWeight = "600";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  const appointmentForm = document.getElementById("appointmentForm");
  const successMsg = document.getElementById("successMsg");
  const submitBtn = appointmentForm.querySelector("button[type='submit']");

  appointmentForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.innerHTML = "‚è≥ Submitting...";
    submitBtn.style.opacity = "0.7";

    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;
    if (startTime >= endTime) {
      alert("‚ö†Ô∏è End time must be later than start time!");
      resetButton();
      return;
    }

    const selectedEquipments = Array.from(document.querySelectorAll(".equipment-btn.selected"))
      .map(b => b.dataset.value)
      .join(", ");

    const data = {
      selectedDate,
      dateRequest: document.getElementById("dateRequest").value,
      requestingOffice: document.getElementById("requestingOffice").value,
      contactPerson: document.getElementById("contactPerson").value,
      contactPersonEmail: document.getElementById("contactPersonEmail").value,
      mobileNumber: document.getElementById("mobileNumber").value,
      eventTitle: document.getElementById("eventTitle").value,
      activityType: document.getElementById("activityType").value,
      otherActivity: document.getElementById("otherActivity").value,
      participants: document.getElementById("participants").value,
      roomLayout: document.getElementById("roomLayout").value,
      equipments: selectedEquipments,
      tablesQty: document.getElementById("tablesQty").value,
      chairsQty: document.getElementById("chairsQty").value,
      otherEquipment: document.getElementById("otherEquipment").value,
      startTime,
      endTime,
      notes: document.getElementById("notes").value
    };

    try {
      const res = await fetch("/send-appointment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        successMsg.style.display = "block";
        successMsg.textContent = "‚è≥ Appointment submitted! Redirecting...";
        showToast("Appointment submitted successfully!", true);

        localStorage.setItem("bookingEmail", data.contactPersonEmail);
        localStorage.setItem("bookingTitle", data.eventTitle);
        localStorage.setItem("bookingStatus", "pending");

        setTimeout(() => (window.location.href = "feedback.html"), 2000);
      } else {
        alert("‚ùå Failed to send appointment. Please try again.");
        resetButton();
      }
    } catch (err) {
      console.error(err);
      alert("‚ö†Ô∏è Error connecting to server.");
      resetButton();
    }
  });

  function resetButton() {
    submitBtn.disabled = false;
    submitBtn.innerHTML = "Submit Appointment";
    submitBtn.style.opacity = "1";
  }
</script>


</body>
</html>
